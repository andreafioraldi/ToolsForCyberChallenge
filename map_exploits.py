#!/usr/bin/env python

__author__ = "Andrea Fioraldi"
__copyright__ = "Copyright 2017, Andrea Fioraldi"
__license__ = "MIT"
__email__ = "andreafioraldi@gmail.com"

import requests
import time
import sys
import random

get_header = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}

def locations_of_substring(string, substring):
    substring_length = len(substring)    
    def recurse(locations_found, start):
        location = string.find(substring, start)
        if location != -1:
            return recurse(locations_found + [location], location+substring_length)
        else:
            return locations_found

    return recurse([], 0)

if len(sys.argv) < 2:
    print "Usage: python map_exploits.py <id list> [restart index]"

file = open(sys.argv[1])
ids = file.readlines()

out = open(sys.argv[1] + ".dict", "a")

i = 0
total_len = str(len(ids))

if len(sys.argv) > 2:
    cont = int(sys.argv[2])
    ids = ids[cont:]
    i = cont

for edb in ids:
    edb = edb.strip()
    if len(edb) == 0: continue

    print "[" + str(i) + " of " + total_len + "] Downloading https://www.exploit-db.com/exploits/" + edb

    while True:
        try:
            r = requests.get("https://www.exploit-db.com/exploits/" + edb, headers=get_header)
        except Exception:
            time.sleep(10)
            continue
        finally:
            break

    indexes = locations_of_substring(r.content, 'https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-')

    used = []
    for pos in indexes:
		cve = r.content[pos + 47: pos + 47 + 13]
		if cve in used: continue
		used.append(cve)
		print "Found: " + cve
		out.write("'" + cve + "' : " + edb + "\n")
		out.flush()
    time.sleep(random.uniform(0.1, 0.5))

    i += 1
